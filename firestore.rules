rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ”’ Meta collection holds your secret
    match /meta/{docId} {
      allow read, write: if false; // nobody can read or edit this
    }

    // ðŸ”‘ Protect the iceTea collection
    match /iceTea/{docId} {
      // Allow create only if the new doc carries the correct secret
      allow create: if request.resource.data.secret ==
        get(/databases/$(database)/documents/meta/auth).data.secret;

      // Allow get/update/delete if the stored doc has the correct secret
      allow get, update, delete: if resource.data.secret ==
        get(/databases/$(database)/documents/meta/auth).data.secret;

      // Allow list queries (needed for getDocs, counters)
      // Safe because results still only include docs whose stored secret matches
      allow list: if get(/databases/$(database)/documents/meta/auth).data.secret != "";
    }
  }
}
